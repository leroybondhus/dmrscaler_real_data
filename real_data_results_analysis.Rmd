---
title: "real_data_results_analysis"
output: html_document
---


```{r}
library(IRanges)
library(GenomicRanges)
library(data.table)
library(stringr)
library(foreach)
library(doParallel)
registerDoParallel(detectCores())
```


```{r }
load("method_set_list.Rdata")
load("data_set_list.Rdata")

```

```{r check method_set parameters }
for(i in 1:length(method_set_list)){
  print(method_set_list[[i]]$function_call )
}
```


```{r add granges for called dmrs}
filenames <- list.files(path = "./results/real_dataset_results/", pattern = "*result.csv", full.names = T)


data_set_results <- list()

for(data_set_id in 1:length(data_set_list)){
  for(method_id in 1:length(method_set_list)){
    filename <- filenames[grep(paste("data_set_",data_set_id,
                                     "__method_set_",method_id,
                                     sep=""), filenames)]
    result <- fread(filename)
    # if(method_set_list[[method_id]]$method=="dmrscaler"){
    #   result <- result[grep("64",result$layer),]
    # }
    
    locs <- data_set_list[[data_set_id]]$locs
    chr_seqlengths <- numeric(length=length(unique(locs$chr)))
    names(chr_seqlengths) <- unique(locs$chr)
    for(chr in unique(locs$chr)){
      chr_seqlengths[chr] <- max(locs$pos[which(locs$chr==chr)])+1
    }
    chr_seqinfo <- Seqinfo(names(chr_seqlengths), seqlengths = chr_seqlengths)
    
    data_set_results[[basename(filename)]]$grange <- GRanges(
      seqnames = result$chr,
      ranges = IRanges(start = result$start,
                       end = result$stop,
                       pval_region = result$pval_region),
      strand = rep("*",nrow(result)),
      seqinfo = chr_seqinfo
    )
    if(grepl("dmrscaler",names(method_set_list)[method_id] )){
      data_set_results[[basename(filename)]]$grange$layer <- result$layer
    }
    ### need to set a cutoff to region p-value for TP,FP, FN, etc
    which <- which(data_set_results[[basename(filename)]]$grange$pval_region < 0.05)
    data_set_results[[basename(filename)]]$grange <- data_set_results[[basename(filename)]]$grange[which]
    
    data_set_results[[basename(filename)]]$locs_grs <- GRanges(seqnames=locs$chr, ranges = IRanges(start=locs$pos, width=1))
    data_set_results[[basename(filename)]]$method <- names(method_set_list)[method_id]
    data_set_results[[basename(filename)]]$data_set <- data_set_list[[data_set_id]]$z
    
    
  }
}
```

```{r}

```

```{r}

```

```{r}

```

```{r}

```


```{r make pretty table}

library("gt")

results_table <- data.frame("method"=character(),
                            "chrX_num_dmrs"=numeric(), 
                            "chrX_mean_width"=numeric(),
                            "chrX_median_width"=numeric(),
                            "chrX_percent_total_width"=numeric(),
                            "autosome_num_dmrs"=numeric(), 
                            "autosome_avg_width"=numeric(),
                            "autosome_median_width"=numeric(),                            
                            "autosome_percent_total_width"=numeric())


data_set_id <- grep("Sex", names(data_set_list))
result_set_ids <- grep(paste("data_set_", data_set_id, sep = ""), names(data_set_results))
for(rs_index in result_set_ids){
  result_set <- data_set_results[[rs_index]] 
  if(grepl("dmrscaler", result_set$method)){
    if(grepl("_1", result_set$method)){
      for(l in 1:length(unique(result_set$grange$layer))){
        which_x <- which(result_set$grange@seqnames=="chrX" &
                           result_set$grange$layer == unique(result_set$grange$layer)[l])
        which_not_x <- which(result_set$grange@seqnames != "chrX" & result_set$grange@seqnames != "chrY" &
                           result_set$grange$layer == unique(result_set$grange$layer)[l])
        results_table <- rbind(results_table,
                               data.frame("method" = result_set$method,
                                          "chrX_num_dmrs" = length(which_x),
                                          "chrX_mean_width" = mean(width(result_set$grange[which_x,])),
                                          "chrX_median_width" = median(width(result_set$grange[which_x,])), 
                                          "chrX_percent_total_width" = sum(width(result_set$grange[which_x,])) / 
                                            seqlengths(result_set$grange)["chrX"],
                                          "autosome_num_dmrs" = length(which_not_x),
                                          "autosome_mean_width" = mean(width(result_set$grange[which_not_x,])),
                                          "autosome_median_width"=median(width(result_set$grange[which_not_x,])),
                                          "autosome_percent_total_width" = sum(width(result_set$grange[which_not_x,])) / 
                                            sum(seqlengths(result_set$grange)[!grepl("[XY]",names(seqlengths(result_set$grange)))])
                         ))
        rownames(results_table)[nrow(results_table)] <- unique(result_set$grange$layer)[l] 
      }
    }
  }else{
    which_x <- which(result_set$grange@seqnames=="chrX")
    which_not_x <- which(result_set$grange@seqnames != "chrX" & result_set$grange@seqnames != "chrY")
    results_table <- rbind(results_table,
                           data.frame("method" = result_set$method,
                                      "chrX_num_dmrs" = length(which_x),
                                      "chrX_mean_width" = mean(width(result_set$grange[which_x,])),
                                      "chrX_median_width" = median(width(result_set$grange[which_x,])), 
                                      "chrX_percent_total_width" = sum(width(result_set$grange[which_x,])) / 
                                        seqlengths(result_set$grange)["chrX"],
                                      "autosome_num_dmrs" = length(which_not_x),
                                      "autosome_mean_width" = mean(width(result_set$grange[which_not_x,])),
                                      "autosome_median_width"=median(width(result_set$grange[which_not_x,])),
                                      "autosome_percent_total_width" = sum(width(result_set$grange[which_not_x,])) / 
                                        sum(seqlengths(result_set$grange)[!grepl("[XY]",names(seqlengths(result_set$grange)))])
                     ))
    rownames(results_table)[nrow(results_table)] <- result_set$method
  }
  
  
}



data.frame("method" = result_set$method,
                                          "chrX_num_dmrs" = length(which_x),
                                          "chrX_mean_width" = mean(width(result_set$grange[which_x,])),
                                          "chrX_median_width" = median(width(result_set$grange[which_x,])), 
                                          "chrX_percent_total_width" = sum(width(result_set$grange[which_x,])) / 
                                            seqlengths(result_set$grange)["chrX"],
                                          "autosome_num_dmrs" = length(which_not_x),
                                          "autosome_mean_width" = mean(width(result_set$grange[which_not_x,])),
                         )






for( i in 1:length(built_layers)){
  which <- which(built_layers[[i]]$chr == "chrX")
  which_not <- which(built_layers[[i]]$chr != "chrX" & built_layers[[i]]$chr != "chrY")
  results_table <- rbind(results_table,
                         data.frame("method" = "dmrscaler", 
                         "chrX_num_dmrs" = nrow(built_layers[[i]][which,]),
                         "chrX_mean_width" = mean(built_layers[[i]]$stop_pos[which]-built_layers[[i]]$start_pos[which]),
                         "chrX_median_width"= median(built_layers[[i]]$stop_pos[which]-built_layers[[i]]$start_pos[which]),                         
                         "chrX_percent_total_width" = -1,  # add later
                         "autosome_num_dmrs" = nrow(built_layers[[i]][which_not,]),
                         "autosome_mean_width" = mean(built_layers[[i]]$stop_pos[which_not]-built_layers[[i]]$start_pos[which_not]),
                         "autosome_median_width"= median(built_layers[[i]]$stop_pos[which_not]-built_layers[[i]]$start_pos[which_not]),                            
                         "autosome_percent_total_width" = -1 # add late
                         ))
  rownames(results_table)[i] <- paste("layer ",i,": ",layer_sizes[i] ," adjacent CpGs", sep = "")
}

### Add bumphunter results to table

which <- which(bumps_default$table$chr == "chrX")
which_not <- which(bumps_default$table$chr != "chrX" & bumps_default$table$chr != "chrY")
results_table <- rbind(results_table,
                         data.frame("method" = "bumphunter", 
                         "chrX_num_dmrs" = nrow(bumps_default$table[which,]),
                         "chrX_mean_width" = mean(bumps_default$table$end[which]-bumps_default$table$start[which]),
                         "chrX_median_width"= median(bumps_default$table$end[which]-bumps_default$table$start[which]),                         
                         "chrX_percent_total_width" = -1,  # add later
                         "autosome_num_dmrs" = nrow(bumps_default$table[which_not,]),
                         "autosome_mean_width" = mean(bumps_default$table$end[which_not]-bumps_default$table$start[which_not]),
                         "autosome_median_width"= median(bumps_default$table$end[which_not]-bumps_default$table$start[which_not]),                            
                         "autosome_percent_total_width" = -1 # add late
                         ))
rownames(results_table)[length(rownames(results_table))] <- "default: maxGap = 500 bp"

which <- which(bumps_1Mb$table$chr == "chrX")
which_not <- which(bumps_1Mb$table$chr != "chrX" & bumps_1Mb$table$chr != "chrY")
results_table <- rbind(results_table,
                         data.frame("method" = "bumphunter", 
                         "chrX_num_dmrs" = nrow(bumps_1Mb$table[which,]),
                         "chrX_mean_width" = mean(bumps_1Mb$table$end[which]-bumps_1Mb$table$start[which]),
                         "chrX_median_width"= median(bumps_1Mb$table$end[which]-bumps_1Mb$table$start[which]),                         
                         "chrX_percent_total_width" = -1,  # add later
                         "autosome_num_dmrs" = nrow(bumps_1Mb$table[which_not,]),
                         "autosome_mean_width" = mean(bumps_1Mb$table$end[which_not]-bumps_1Mb$table$start[which_not]),
                         "autosome_median_width"= median(bumps_1Mb$table$end[which_not]-bumps_1Mb$table$start[which_not]),                            
                         "autosome_percent_total_width" = -1 # add late
                         ))
rownames(results_table)[length(rownames(results_table))] <- "maxGap = 1 Mb"




chrXsize <- max(locs$pos[which(locs$chr=="chrX")])
autosome_size <- 0
for(i in 1:22){
  chr <- paste("chr",i,sep = "")
  autosome_size <- autosome_size + max(locs$pos[which(locs$chr==chr)])
}
results_table$chrX_percent_total_width <- results_table$chrX_mean_width * results_table$chrX_num_dmrs / chrXsize

results_table$autosome_percent_total_width <- results_table$autosome_mean_width * results_table$autosome_num_dmrs / autosome_size

results_table$method_params <- rownames(results_table)

clean_results_table <- gt(results_table, groupname_col = "method", rowname_col = "method_params") 
clean_results_table <- tab_header(clean_results_table, title = "Sex Analysis DMR Summary Table")
clean_results_table <- tab_spanner(clean_results_table, label="chrX",
                                   columns = c("chrX_num_dmrs","chrX_mean_width","chrX_median_width", "chrX_percent_total_width") )
clean_results_table <- tab_spanner(clean_results_table, label="Autosomes",
                                   columns = c("autosome_num_dmrs","autosome_mean_width","autosome_median_width", "autosome_percent_total_width") )
clean_results_table <- tab_stubhead(clean_results_table , "method")

clean_results_table <- cols_label(clean_results_table,
                                  chrX_num_dmrs = html(" #\n<br>DMRs "), chrX_mean_width = html(" mean\n<br>DMR width "),
                                  chrX_median_width = html(" median\n<br>DMR width "), chrX_percent_total_width = html(" % total\n<br>width "),
                                  autosome_num_dmrs = html(" #\n<br>DMRs "), autosome_mean_width = html(" mean\n<br>DMR width "),
                                  autosome_median_width = html(" median\n<br>DMR width "), autosome_percent_total_width = html(" % total\n<br>width " ))


clean_results_table <- fmt_number(clean_results_table, columns = vars(chrX_percent_total_width, autosome_percent_total_width),
                                  n_sigfig = 2, scale_by = 100, pattern = "{x}%")

clean_results_table <- fmt_number(clean_results_table, columns = vars(autosome_mean_width),
                                  rows = (autosome_mean_width > 1000) & (autosome_mean_width < 1e6),
                                  decimals = 2, scale_by = 1/1000, pattern = "{x} kb")
clean_results_table <- fmt_number(clean_results_table, columns = vars(autosome_mean_width),
                                  rows = (autosome_mean_width <= 1000),
                                  decimals = 0, pattern = "{x} bp")

clean_results_table <- fmt_number(clean_results_table, columns = vars(chrX_mean_width),
                                  rows = (chrX_mean_width >= 1e6),
                                  decimals = 2, scale_by = 1/1e6, pattern = "{x} Mb")
clean_results_table <- fmt_number(clean_results_table, columns = vars(chrX_mean_width),
                                  rows = (chrX_mean_width > 1000) & (chrX_mean_width < 1e6),
                                  decimals = 2, scale_by = 1/1000, pattern = "{x} kb")
clean_results_table <- fmt_number(clean_results_table, columns = vars(chrX_mean_width),
                                  rows = (chrX_mean_width <= 1000),
                                  decimals = 0, pattern = "{x} bp")

clean_results_table <- fmt_number(clean_results_table, columns = vars(chrX_median_width),
                                  rows = (chrX_median_width >= 1e6),
                                  decimals = 2, scale_by = 1/1e6, pattern = "{x} Mb")
clean_results_table <- fmt_number(clean_results_table, columns = vars(chrX_median_width),
                                  rows = (chrX_median_width > 1000) & (chrX_median_width < 1e6),
                                  decimals = 2, scale_by = 1/1000, pattern = "{x} kb")
clean_results_table <- fmt_number(clean_results_table, columns = vars(chrX_median_width),
                                  rows = (chrX_median_width <= 1000),
                                  decimals = 0, pattern = "{x} bp")

clean_results_table <- fmt_number(clean_results_table, columns = vars(autosome_median_width),
                                  rows = (autosome_median_width >= 1e6),
                                  decimals = 2, scale_by = 1/1e6, pattern = "{x} Mb")
clean_results_table <- fmt_number(clean_results_table, columns = vars(autosome_median_width),
                                  rows = (autosome_median_width > 1000) & (autosome_median_width < 1e6),
                                  decimals = 2, scale_by = 1/1000, pattern = "{x} kb")
clean_results_table <- fmt_number(clean_results_table, columns = vars(autosome_median_width),
                                  rows = (autosome_median_width <= 1000),
                                  decimals = 0, pattern = "{x} bp")


clean_results_table

gtsave(clean_results_table, filename = paste(results_dir, "/Sex_Analysis_DMR_Summary_Table_2.png",sep=""))
  fmt_scientific(
    columns = vars(num),
    rows = num <= 500,
    decimals = 1
  )
 fmt_number(
    columns = vars(num),
    rows = num > 500,
    decimals = 1,
    scale_by = 1/1000,
    pattern = "{x}K"
  )
```
